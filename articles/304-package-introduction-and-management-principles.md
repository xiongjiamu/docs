# 304 龙蜥社区软件包引入和管理原则

<a name="hvwEP"></a>
## 1. 综述
### 1.1 文档范围
本文档涵盖：

- 龙蜥社区产品发布 SIG 成员在引入或维护 RPM 软件包时需遵循的准入原则及操作流程；
- 龙蜥社区开发者及各 SIG 成员将 RPM 引入 Anolis OS 发行版时需遵循的准入原则及操作流程。

本文档不涵盖：

- 源码引入原则及操作流程。源码引入到龙蜥社区是另外的话题，需要单独向龙蜥社区技术委员会申请；
- 软件包引入规则的原理解析；
- 软件包引入时 RPM SPEC 的编写细节。

本文档的维护主体为**龙蜥社区技术委员会**，文档定稿或重大修改均需报请技术委员会审议，通过后施行。

<a name="zxVJL"></a>
### 1.2 术语定义

在本文描述中，软件包代码在仓库中的组织形式分为两种，分别为「source tree」和「rpm tree」。

- 「**source tree**」 是指项目源码本身，在 Gitee 中以源码协作开发的方式维护，并按照软件自身研发节奏发布对应的 release，供其他社区或者爱好者进行下载使用，本文档不涉及 source tree 的组织与管理；
- 「**rpm tree**」 是用于龙蜥社区构建发行版和 SIG 组构建产品对应的软件包的代码树，通常包含 rpm spec 文件 + 包含源码的 tarball，可用于后续构建和发布。这部分软件按照软件的成熟度分别放在对应不同的 Gitee 仓库。

<a name="BlXJ3"></a>
### 1.3 修订记录

| **时间** | **作者** | **描述** | **审核人** |
| --- | --- | --- | --- |
| 2022/08/31 | happy_orange, caspar | v1.0 - 初始版本 |  |

<a name="ImUMC"></a>
## 2. 软件包管理基础设施介绍

龙蜥社区使用 Gitee 管理 Anolis OS 发行版及所有 SIG 组的软件包代码，统一放在 [https://gitee.com/openanolis]() 组织下。

<a name="pujf7"></a>
### 2.1 软件包在代码仓库的位置

此处展示使用较为频繁的几个软件包仓库的信息：

| **类别** | **仓库名称** | **仓库地址** | **仓库介绍** |
| --- | --- | --- | --- |
| source tree | anolis | [https://gitee.com/anolis](https://gitee.com/anolis) | 存放龙蜥社区所有项目的 source tree，本文不涉及。 |
| rpm tree | src-anolis-os | [https://gitee.com/src-anolis-os](https://gitee.com/src-anolis-os) | 存放 Anolis OS 发行版默认 RPM 打包代码 |
|  | src-anolis-sig | [https://gitee.com/src-anolis-sig](https://gitee.com/src-anolis-sig) | 存放龙蜥社区各 SIG RPM 打包代码 |
|  | src-anolis-xxx |  | 其他特殊 SIG 的 RPM 打包代码 |

<a name="fyhqu"></a>
### 2.2 代码分支管理
对于 rpm tree，每个软件仓库会通过特定分支进行进一步统一管理，确保不同的 OS 版本都有对应分支可映射；在初始化仓库时，应该建立对应版本的分支，后续将代码提交 PR 通过 review 后合入到对应分支上。

| **分支名称** | **介绍** |
| --- | --- |
| **master**, **main** | 默认都为空，用于初始化其他发行版对应的分支，禁止使用该分支管理代码。 |
| **aX** (X 为不带任何后缀的大版本数字），如 a7, a8, a23, a25 等 | Anolis OS X 版本的主线分支。 |
| **aX.Y** (X 为大版本数字，Y 为对应小版本数字），如 a8.2, a8.6 等 | Anolis OS X 以前发布过的 Y 小版本对应的分支，最新的主线分支开出后，之前的主线分支则重命名为形如 aX.Y 的形式。 |
| **aX-{module名}-stream-{版本名称}** 或<br />**aX.Y-{module名}-stream-{版本名称}** | Anolis OS X 或者 X.Y 版本对应的 module 的模块化版本分支。 |
|  | 

<a name="cXqft"></a>
## 3. 软件包引入
<a name="wpzHw"></a>
### 3.1 软件包引入原则
软件包引入申请人主体可以是产品发布 SIG 组成员，也可以是其他 SIG 组对应软件包的 owner（以下统一称为「软件包负责人」）。当软件包引入前，软件包负责人需明确软件包引入原则，不符合软件包引入原则的组件，不允许引入。

**程度** | **要求项** | **补充说明** 
--|--|--
must | 软件包的内容必须遵守国家法律法规、遵守社会公序良俗 | 
must | 软件包不允许存在合规、安全问题 | 例如：无 license 或 license 尚存在争议的软件 
must | 软件包能给出明确的 License，并且属于开源软件的白名单范围内 | [license 白名单](https://gitee.com/anolis/anolis-ci-test/blob/master/utils/license_check/white_black.xlsx)
must | 软件包在引入时，应该说明背景和用途 | 
must | 软件包在龙蜥社区的 rpm tree 中从未引入过，且软件命名规范，遵循上游社区命名方式 | 同一款软件只能存在 rpm tree 的其中一个仓，如有，后加的仓库应当合并到先有的仓库。例如：src-anolis-os 和 src-anolis-sig 不可以包含同名软件包 
must | source.tag.gz 从上游开源社区下载正式发布版本 | md5 值和上游相同 |
must | 原则不允许引入其他二进制，所有的构建依赖和运行依赖都要满足已经存在 OS 的发行版内 | 针对孵化期内的软件，支持额外讨论决策 
must | 需要从源码构建，生成对应的 rpm | 如果对构建依赖版本多要求的（比如：依赖多个 kernel-devel 版本），则需要构建多次 
must | 软件包对应的上游开源社区仍在运营，并在持续发布 release | 运营是指有代码提交、代码和入、issue解决等，代表上游社区的代码仓并没有被废弃
must | 软件包所需要的全部运行依赖必须已经存在，如果不存在，则必须按照同等规则先引入  | 
must | 软件包 owner 需要评估软件的运行平台，缺省默认全部支持，如果存在不支持的架构则需要额外声明 | 目前龙蜥社区支持列表为：x86_64、aarch64 和 loongarch64 

<a name="S6HMX"></a>
### 3.2  版本选型原则
龙蜥社区的软件选型主要围绕「分层分类」理论展开，根据软件包对操作系统发行版的重要程度，以及整体应用场景模块化程度，设立不同的选型原则。

- 优先级上参照「分层分类」理论中的分层思想，从层级优先级高的软件包开始重点制定和维护策略；
- 场景上参照「分层分类」理论中的分类思想，按应用场景维度分割，模块化地分批引入软件包；

| **layer 序号** | **layer 名称** | **详细描述** | **选型规则** |
| --- | --- | --- | --- |
| layer-0 | 内核层 | 操作系统服务（内核） | <br />1. 跟随上游内核社区，选取社区成熟期 LTS 版本；<br />2. 选型需兼顾龙蜥社区 IHV 生态支持最完整的内核版本，降低硬件补丁回合成本；<br />3. 选型需兼顾龙蜥理事成员单位向上游贡献重大特性较多的内核版本，降低特性回合成本；<br />4. 在一个 OS 版本内不发生大版本变更，仅采取 release 更新形式，以补丁形式合入。<br /> |
| layer-1 | 核心层 | 核心工具、核心库、核心服务 | <br />1. 跟随上游社区，选取社区稳定版本或 LTS 版本；<br />2. 和硬件相关的组件选型时需兼顾龙蜥社区 IHV 生态支持最完整的版本，降低硬件补丁回合成本；<br />3. 在一个 OS 版本内主要版本不发生大版本变更，仅采取 release 更新形式，以补丁形式合入；<br />4. 原则上不允许同时引入多个版本（例如 libssh, libssh2 需要选择一个版本）。<br /> |
| layer-2 | 系统层 | 系统工具、系统库、系统服务 | <br />1. 跟随上游社区，选取社区稳定版本或 LTS 版本；<br />2. 和硬件相关的组件选型时需兼顾龙蜥社区 IHV 生态支持最完整的版本，降低硬件补丁回合成本；<br />3. 在一个 OS 版本内主要版本不发生大版本变更，仅采取 release 更新形式，以补丁形式合入；<br />4. 原则上不允许同时引入多个版本（例如 libssh, libssh2 需要选择一个版本）。<br /> |
| layer-3 | 应用层 | 应用工具、应用库、应用服务 | <br />1. 尽量选取正式发布的最新版本；<br />2. 允许在一个 OS 版本内发生 version 变更，但要对影响范围整体评估清楚，必须通过**兼容性验证**；<br />3. 原则上不允许同时引入多个版本。<br /> 4. 自研 module 包可以采用 module 模式进行管理，保障单一大版本演进过程的应用软件兼容性 |
| layer-4 | 应用场景 | 数据库、云原生、大数据、桌面等应用场景 | <br />1. 优先选择最新的，其次如果最新的版本带来不兼容（对其他软件产生影响）的问题，则可以选取次新版本；<br />2. 允许支持某款软件存在多个版本，但需要由需求驱动，比如：tomcat 7、tomcat 8、tomcat 9等。<br />3. 具体业务涉及的软件版本可以由对应负责人决策，不做过多要求。<br /> |

<a name="ecHTK"></a>
### 3.3 SPEC 规范
详细规范请参阅 [Anolis OS 23 spec 规范](/articles/305-module-and-checklist-of-spec.md)。<br />下列情形需严格遵守该规范编写 SPEC 文件：

- Anolis OS 23 及以后的发行版引入的所有软件包；
- Anolis OS 7, Anolis OS 8 中新引入的软件包。

下列情形可参考本规范，并不强制执行：
- Anolis OS 7 和 Anolis OS 8 中现存的软件包。

<a name="pTJxk"></a>
### 3.4 软件包引入流程
1. **引入条件审查**：软件包负责人需根据 「[3.1 软件包引入原则](#wpzHw)」 和 「[3.2 版本选型原则](#S6HMX)」所载明的规范要求，明确软件包的代码符合要求、版本选型符合规范，同时明确软件包的演进和维护路线。
1. **提交软件包引入申请**：软件包引入涉及发行版基线变更，基线数据是通过社区的软件包集成项目 ([ospkg-list](https://gitee.com/anolis/ospkg-list)) 管理的。每一个软件包都需要通过 Pull Request 提交引入意向申请。该申请将由产品发布 SIG maintainer 负责审阅，必要时报请技术委员会成员审阅，如通过后则完成软件包基线数据的变更。
   1. 如果软件包在 ospkg-list 里不存在，则需要参照「[附录1.1 软件包引入申请模板](#XvmFu)」填写一个新的 `{package}.yaml`文件。申请通过后由产品发布 SIG maintainer 创建新的仓库和对应分支；
   1. 如果软件包在 ospkg-list 里已经存在，则无需提交新的 `{package}.yaml`，在现有软件包数据中添加新的字段即可。申请通过后由产品发布 SIG maintainer在现有仓库创建新的分支。
1. **提交软件包代码**：根据 「[305 SPEC 规范](../articles/305-module-and-checklist-of-spec.md)」制作符合要求的 rpm tree 代码，并提交 PR 到对应的软件包分支中。
1. **完成引入:** 产品发布 SIG  maintainer，必要时社区技术委员会指派成员，根据 review 规范审核对应的 PR，如通过后则完成软件包整体引入。其他 review 结果包括：打回修改，拒绝等。如拒绝则需给出明确的理由。

<a name="EAU9e"></a>
## 4. 软件包构建
软件包构建从构建目的角度可以划分为两种：自验证构建和正式构建。

<a name="A4x8c"></a>
### 4.1 自验证构建
该过程为开发者自行在本地或模拟环境中对软件进行构建，以验证软件包本身的构建能力或产出测试包供后续测试。目前推荐的方式有两种：

- 本地通过 mock 机制构建，参考《[Anolis OS 8 软件包本地构建 · 语雀](https://www.yuque.com/anolis-docs/kbase/cvy9g3?view=doc_embed)》一文；
- 通过 Anolis Build System (ABS) 提供的个人工作空间机制进行自定义构建，可以参考[《使用ABS平台轻松胜任Anolis OS开发工作》](../articles/208-how-to-build-package-via-ABS.md) 一文的内容，进行构建。

<a name="qlUtC"></a>
### 4.2 正式构建
正式构建的产物将会发布到对应的 Anolis OS 发行版本中，因此需要慎重操作。正式构建操作需要通过命令行操作，并且需要提前获得相关 token，请联系龙蜥社区发
布小组 maintainer 获取相关 token。

<a name="pAits"></a>
## 5. 软件包发布与变更

<a name="gYQMQ"></a>
### 5.1 软件包发布原则
软件包发布指的是将通过正式构建流程生成的二进制推送到镜像 YUM repo 中。发布时会根据 ospkg-list 工具中的软件包基线数据信息，推送到对应的 YUM repo 中。<br />软件包经过正式构建得到 RPM 产物后，并不能直接发布，需要经过 abs 系统集成的 CI 流程后，由产品发布 SIG maintainer 执行软件包签名，之后推送 YUM repo 并生成发布单(Errata)。

<a name="HBFJF"></a>
### 5.2 软件包成熟度变更原则
软件包成熟度与 YUM 位置相关，基本原则如下：

- Anolis OS 每个大版本初次选型，成熟度自动为「系统包」级别；
- Anolis OS 发布后各个时期的软件包选型，如无特殊说明，成熟度自动为「孵化包」级别。

如软件包符合下列条件，可以变更成熟度：

- 符合软件包孵化成熟标准的软件包，可以从孵化池中结束孵化，变更为「成熟包」级别，条件如下：
   - 软件包维护责任人清晰，维护计划清晰；
   - 软件包代码质量稳定，通过所有 CI 检测条件，通过功能性测试，稳定维护至少一个软件包迭代周期；
- 符合软件包系统包标准的软件包，可以变更为「系统包」级别，条件如下：
   - 软件包维护责任人清晰，维护计划清晰；
   - 软件包代码质量稳定，通过所有 CI 检测条件，通过功能性测试，稳定维护至少一个软件包迭代周期；
   - 软件包是 Anolis OS 必不可少的基础 OS 组件，或者是社区重点应用生态场景（场景列表见「[附录 1.2 社区重点应用生态场景](#Xwfk2)」；
- 符合软件包删除原则的软件包，需从 YUM 仓库删除，状态变更为「退休」级别。

<a name="wdhrq"></a>
### 5.3 软件包发布流程

1. 经过正式构建得到候选发布(release candidate)包，abs 自动执行集成的 CI 流程，如未自动执行，则可在 abs 系统手工触发；
1. 通过所有 CI 测试项，或手工确认失败项无影响后，则达到发布条件。在  [Bugzilla 平台](https://bugzilla.openanolis.cn/enter_bug.cgi?classification=Anolis%20OS) 提交软件包发布需求，模板参考「[附录 1.3 软件包发布需求模板](#A5FyM)」；同时需填写发布单(Errata)，如有多个软件包，则只需填写一个发布单即可，模板参考「附录 1.4 发布单模板」。
1. 产品发布 SIG maintainer 确认通过发布需求，分别执行软件包签名、推送 YUM repo、生成发布单操作，如软件包达到系统包级别，则还需额外更新镜像 comps 文件。

<a name="Smfsj"></a>
### 5.4 软件包成熟度变更流程

1. 在 ospkg-list 提交 PR，表明需要修改的目标成熟度，并在 commit 或 PR 描述中陈述软件包成熟度变更的必要性；
1. 产品发布 SIG maintainer 审核通过后，如涉及到仓库位置改动，需由产品发布 SIG maintainer 执行仓库位置改动操作。

<a name="jyoua"></a>
## 6. 软件包删除
当某些开源软件不再符合 OpenAnolis 的规范时，需要将其从社区中删除。目前已知条件如下，持续更新：

| **序号** | **分类** | **条件** |
| --- | --- | --- |
| 1 | 版权 | 软件的版权信息发生变更，如：license 存在争议、转商用等 |
| 2 | 代码风险 | 源码中存在恶意代码或者安全隐患，且无法修复或上游社区反馈不修复 |
| 3 |  | 源码中存在争议风险，如：地区命名、民族习俗等 |
| 4 | 软件演进 | 开源社区不再进行维护，持续长时间无任何提交和 bug 讨论，考虑退出 |
| 5 |  | 软件落后，存在其他同类软件替代 |
| 6 |  | 功能不再被需要，可以无影响删除 |

<a name="Oy6aK"></a>
## 附录1
<a name="XvmFu"></a>
### 附录 1.1 软件包引入申请模板
```yaml
name: my_packages
repository: https://gitee.com/src-anolis-sig/my_package
summary: a short description
rpm_owner: anolis-bot
branches:
- name: a8
  repo: epao
  maturity：rawhide
- name: a23
  repo: epao
  maturity：rawhide
```
<a name="Xwfk2"></a>
### 附录 1.2 社区重点生态应用场景

- 数据库
- 云原生
- Web Server

<a name="A5FyM"></a>
### 附录 1.3 软件包发布需求模板

> 申请发布

<a name="leuKO"></a>
### 附录 1.4 发布单模板
> 


